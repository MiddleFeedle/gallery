{"ast":null,"code":"const DB_NAME = 'Pictures';\nconst OBJECT_STORE_NAME = 'objectStore';\n\nfunction openDatabasePromise(keyPath) {\n  return new Promise((resolve, reject) => {\n    const dbOpenRequest = window.indexedDB.open(DB_NAME, 1);\n\n    dbOpenRequest.onblocked = () => {\n      reject(\"Что-то пошло не так.\");\n    };\n\n    dbOpenRequest.onerror = err => {\n      console.log('Unable to open indexedDB ' + DB_NAME);\n      console.log(err);\n      reject('Невозможно открыть базу данных.');\n    };\n\n    dbOpenRequest.onupgradeneeded = event => {\n      const db = event.target.result;\n\n      try {\n        db.deleteObjectStore(OBJECT_STORE_NAME);\n      } catch (err) {\n        console.log(err);\n      }\n\n      db.createObjectStore(OBJECT_STORE_NAME, {\n        keyPath\n      });\n    };\n\n    dbOpenRequest.onsuccess = () => {\n      console.info('Successfully open indexedDB connection to ' + DB_NAME);\n      resolve(dbOpenRequest.result);\n    };\n\n    dbOpenRequest.onerror = reject;\n  });\n} // Оборачиваем функции от ObjectStore, поддерживающие интерфейс IDBRequest\n// в вызов с использованием Promise\n\n\nfunction wrap(methodName) {\n  return function () {\n    const [objectStore, ...etc] = arguments;\n    return new Promise((resolve, reject) => {\n      const request = objectStore[methodName](...etc);\n\n      request.onsuccess = () => resolve(request.result);\n\n      request.onerror = reject;\n    });\n  };\n}\n\nconst deletePromise = wrap('delete');\nconst getAllPromise = wrap('getAll');\nconst getPromise = wrap('get');\nconst putPromise = wrap('put');\nexport default class IndexedDbRepository {\n  constructor(keyPath) {\n    this.error = null;\n    this.keyPath = keyPath; // конструктор нельзя объявить как async\n    // поэтому вынесено в отдельную функцию\n\n    this.openDatabasePromise = this._openDatabase(keyPath);\n  }\n\n  async _openDatabase(keyPath) {\n    try {\n      this.dbConnection = await openDatabasePromise(keyPath);\n    } catch (error) {\n      this.error = error;\n      throw error;\n    }\n  }\n\n  async _tx(txMode, callback) {\n    await this.openDatabasePromise; // await db connection\n\n    const transaction = this.dbConnection.transaction([OBJECT_STORE_NAME], txMode);\n    const objectStore = transaction.objectStore(OBJECT_STORE_NAME);\n    return await callback(objectStore);\n  }\n\n  async findAll() {\n    return this._tx('readonly', objectStore => getAllPromise(objectStore));\n  }\n\n  async findById(key) {\n    return this._tx('readonly', objectStore => getPromise(objectStore, key));\n  }\n\n  async deleteById(key) {\n    return this._tx('readwrite', objectStore => deletePromise(objectStore, key));\n  }\n\n  async save(item) {\n    return this._tx('readwrite', objectStore => putPromise(objectStore, item));\n  }\n\n}","map":{"version":3,"sources":["C:/Users/middl/Desktop/DevIT project/devit-project/src/db/connection.js"],"names":["DB_NAME","OBJECT_STORE_NAME","openDatabasePromise","keyPath","Promise","resolve","reject","dbOpenRequest","window","indexedDB","open","onblocked","onerror","err","console","log","onupgradeneeded","event","db","target","result","deleteObjectStore","createObjectStore","onsuccess","info","wrap","methodName","objectStore","etc","arguments","request","deletePromise","getAllPromise","getPromise","putPromise","IndexedDbRepository","constructor","error","_openDatabase","dbConnection","_tx","txMode","callback","transaction","findAll","findById","key","deleteById","save","item"],"mappings":"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","sourcesContent":["\r\nconst DB_NAME = 'Pictures';\r\nconst OBJECT_STORE_NAME = 'objectStore';\r\n\r\n\r\nfunction openDatabasePromise( keyPath : string ) : Promise< IDBDatabase > {\r\n  return new Promise( ( resolve, reject ) => {\r\n    const dbOpenRequest = window.indexedDB.open( DB_NAME, 1 );\r\n\r\n    dbOpenRequest.onblocked = () => {\r\n      reject(\"Что-то пошло не так.\");\r\n    };\r\n\r\n    dbOpenRequest.onerror = err => {\r\n      console.log( 'Unable to open indexedDB ' + DB_NAME );\r\n      console.log( err );\r\n      reject( 'Невозможно открыть базу данных.');\r\n    };\r\n\r\n    dbOpenRequest.onupgradeneeded = event => {\r\n      const db = event.target.result;\r\n      try {\r\n        db.deleteObjectStore( OBJECT_STORE_NAME );\r\n      } catch ( err ) { console.log( err ); }\r\n      db.createObjectStore( OBJECT_STORE_NAME, { keyPath } );\r\n    };\r\n\r\n    dbOpenRequest.onsuccess = () => {\r\n      console.info( 'Successfully open indexedDB connection to ' + DB_NAME );\r\n      resolve( dbOpenRequest.result );\r\n    };\r\n\r\n    dbOpenRequest.onerror = reject;\r\n  } );\r\n}\r\n\r\n// Оборачиваем функции от ObjectStore, поддерживающие интерфейс IDBRequest\r\n// в вызов с использованием Promise\r\nfunction wrap( methodName : string ) {\r\n  return function() {\r\n    const [ objectStore, ...etc ] = arguments;\r\n    return new Promise( ( resolve, reject ) => {\r\n      const request = objectStore[ methodName ]( ...etc );\r\n      request.onsuccess = () => resolve( request.result );\r\n      request.onerror = reject;\r\n    } );\r\n  };\r\n}\r\nconst deletePromise = wrap( 'delete' );\r\nconst getAllPromise = wrap( 'getAll' );\r\nconst getPromise = wrap( 'get' );\r\nconst putPromise = wrap( 'put' );\r\n\r\nexport default class IndexedDbRepository {\r\n\r\n  dbConnection : ?IDBDatabase;\r\n  error : ?any;\r\n  openDatabasePromise : Promise< IDBDatabase >;\r\n\r\n  constructor( keyPath : string ) {\r\n    this.error = null;\r\n    this.keyPath = keyPath;\r\n\r\n    // конструктор нельзя объявить как async\r\n    // поэтому вынесено в отдельную функцию\r\n    this.openDatabasePromise = this._openDatabase( keyPath );\r\n  }\r\n\r\n  async _openDatabase( keyPath : string ) {\r\n    try {\r\n      this.dbConnection = await openDatabasePromise( keyPath );\r\n    } catch ( error ) {\r\n      this.error = error;\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async _tx( txMode : string, callback ) {\r\n    await this.openDatabasePromise; // await db connection\r\n    const transaction : IDBTransaction = this.dbConnection.transaction( [ OBJECT_STORE_NAME ], txMode );\r\n    const objectStore : IDBObjectStore = transaction.objectStore( OBJECT_STORE_NAME );\r\n    return await callback( objectStore );\r\n  }\r\n\r\n  async findAll() : Promise< any[] > {\r\n    return this._tx( 'readonly', objectStore => getAllPromise( objectStore ) );\r\n  }\r\n\r\n  async findById( key ) : Promise< any > {\r\n    return this._tx( 'readonly', objectStore => getPromise( objectStore, key ) );\r\n  }\r\n\r\n  async deleteById( key ) : Promise< any > {\r\n    return this._tx( 'readwrite', objectStore => deletePromise( objectStore, key ) );\r\n  }\r\n\r\n  async save( item : any ) : Promise< any > {\r\n    return this._tx( 'readwrite', objectStore => putPromise( objectStore, item ) );\r\n  }\r\n\r\n}\r\n"]},"metadata":{},"sourceType":"module"}