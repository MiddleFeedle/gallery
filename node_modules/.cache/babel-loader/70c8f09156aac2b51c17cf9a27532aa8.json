{"ast":null,"code":"const DB_NAME = 'Storage';\nconst OBJECT_STORE_NAME = 'Pictures';\n\nfunction openDatabasePromise(keyPath) {\n  return new Promise((resolve, reject) => {\n    const dbOpenRequest = window.indexedDB.open(DB_NAME, 1);\n\n    dbOpenRequest.onblocked = () => {\n      reject(\"Что-то пошло не так.\");\n    };\n\n    dbOpenRequest.onerror = err => {\n      console.log('Unable to open indexedDB ' + DB_NAME);\n      console.log(err);\n      reject('Невозможно открыть базу данных.');\n    };\n\n    dbOpenRequest.onupgradeneeded = event => {\n      const db = event.target.result;\n      var objectStore = db.createObjectStore('Pictures', {\n        keyPath: 'id',\n        autoIncrement: true\n      });\n      objectStore.createIndex(\"format\", \"format\", {\n        unique: false\n      });\n      objectStore.createIndex(\"height\", \"height\", {\n        unique: false\n      });\n      objectStore.createIndex(\"size\", \"size\", {\n        unique: false\n      });\n      objectStore.createIndex(\"type\", \"type\", {\n        unique: false\n      });\n      objectStore.createIndex(\"date\", \"date\", {\n        unique: false\n      });\n      objectStore.createIndex(\"desc\", \"desc\", {\n        unique: false\n      });\n      objectStore.createIndex(\"tags\", \"tags\", {\n        unique: false\n      });\n      objectStore.createIndex(\"value\", \"value\", {\n        unique: false\n      });\n    };\n\n    dbOpenRequest.onsuccess = () => {\n      console.info('Successfully open indexedDB connection to ' + DB_NAME);\n      resolve(dbOpenRequest.result);\n    };\n\n    dbOpenRequest.onerror = reject;\n  });\n} // Оборачиваем функции от ObjectStore, поддерживающие интерфейс IDBRequest\n// в вызов с использованием Promise\n\n\nfunction wrap(methodName) {\n  return function () {\n    const [objectStore, ...etc] = arguments;\n    return new Promise((resolve, reject) => {\n      const request = objectStore[methodName](...etc);\n\n      request.onsuccess = () => resolve(request.result);\n\n      request.onerror = reject;\n    });\n  };\n}\n\nconst deletePromise = wrap('delete');\nconst getAllPromise = wrap('getAll');\nconst getPromise = wrap('get');\nconst putPromise = wrap('put');\nexport default class IndexedDbRepository {\n  constructor(keyPath) {\n    this.error = null;\n    this.keyPath = keyPath; // конструктор нельзя объявить как async\n    // поэтому вынесено в отдельную функцию\n\n    this.openDatabasePromise = this._openDatabase(keyPath);\n  }\n\n  async _openDatabase(keyPath) {\n    try {\n      this.dbConnection = await openDatabasePromise(keyPath);\n    } catch (error) {\n      this.error = error;\n      throw error;\n    }\n  }\n\n}","map":{"version":3,"sources":["C:/Users/middl/Desktop/DevIT project/devit-project/src/db/connection.js"],"names":["DB_NAME","OBJECT_STORE_NAME","openDatabasePromise","keyPath","Promise","resolve","reject","dbOpenRequest","window","indexedDB","open","onblocked","onerror","err","console","log","onupgradeneeded","event","db","target","result","objectStore","createObjectStore","autoIncrement","createIndex","unique","onsuccess","info","wrap","methodName","etc","arguments","request","deletePromise","getAllPromise","getPromise","putPromise","IndexedDbRepository","constructor","error","_openDatabase","dbConnection"],"mappings":"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","sourcesContent":["\r\nconst DB_NAME = 'Storage';\r\nconst OBJECT_STORE_NAME = 'Pictures';\r\n\r\n\r\nfunction openDatabasePromise( keyPath : string ) : Promise< IDBDatabase > {\r\n  return new Promise(( resolve, reject ) => {\r\n    const dbOpenRequest = window.indexedDB.open( DB_NAME, 1 );\r\n\r\n    dbOpenRequest.onblocked = () => {\r\n      reject(\"Что-то пошло не так.\");\r\n    };\r\n\r\n    dbOpenRequest.onerror = err => {\r\n      console.log( 'Unable to open indexedDB ' + DB_NAME );\r\n      console.log( err );\r\n      reject( 'Невозможно открыть базу данных.');\r\n    };\r\n\r\n    dbOpenRequest.onupgradeneeded = event => {\r\n      const db = event.target.result;\r\n\r\n      var objectStore = db.createObjectStore('Pictures', {keyPath:'id', autoIncrement: true});\r\n\r\n            objectStore.createIndex(\"format\", \"format\", { unique: false });\r\n            objectStore.createIndex(\"height\", \"height\", { unique: false });\r\n            objectStore.createIndex(\"size\", \"size\", { unique: false });\r\n            objectStore.createIndex(\"type\", \"type\", { unique: false });\r\n            objectStore.createIndex(\"date\", \"date\", { unique: false });\r\n            objectStore.createIndex(\"desc\", \"desc\", { unique: false });\r\n            objectStore.createIndex(\"tags\", \"tags\", { unique: false });\r\n            objectStore.createIndex(\"value\", \"value\", { unique: false });\r\n\r\n    };\r\n\r\n\r\n    dbOpenRequest.onsuccess = () => {\r\n      console.info( 'Successfully open indexedDB connection to ' + DB_NAME );\r\n      resolve( dbOpenRequest.result );\r\n    };\r\n\r\n    dbOpenRequest.onerror = reject;\r\n  } );\r\n}\r\n\r\n// Оборачиваем функции от ObjectStore, поддерживающие интерфейс IDBRequest\r\n// в вызов с использованием Promise\r\n\r\nfunction wrap( methodName : string ) {\r\n  return function() {\r\n    const [ objectStore, ...etc ] = arguments;\r\n    return new Promise( ( resolve, reject ) => {\r\n      const request = objectStore[ methodName ]( ...etc );\r\n      request.onsuccess = () => resolve( request.result );\r\n      request.onerror = reject;\r\n    } );\r\n  };\r\n}\r\nconst deletePromise = wrap( 'delete' );\r\nconst getAllPromise = wrap( 'getAll' );\r\nconst getPromise = wrap( 'get' );\r\nconst putPromise = wrap( 'put' );\r\n\r\nexport default class IndexedDbRepository {\r\n\r\n\r\n  constructor( keyPath : string ) {\r\n    this.error = null;\r\n    this.keyPath = keyPath;\r\n\r\n    // конструктор нельзя объявить как async\r\n    // поэтому вынесено в отдельную функцию\r\n    this.openDatabasePromise = this._openDatabase( keyPath );\r\n  }\r\n\r\n  async _openDatabase( keyPath : string ) {\r\n    try {\r\n      this.dbConnection = await openDatabasePromise( keyPath );\r\n    } catch ( error ) {\r\n      this.error = error;\r\n      throw error;\r\n    }\r\n  }\r\n\r\n\r\n}\r\n"]},"metadata":{},"sourceType":"module"}